<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Scorecard</title>
    <style>
      html, body { margin:0; padding:0; background:transparent; }
      #wrap { display:flex; align-items:center; justify-content:center; width:100vw; height:100vh; }
      img { display:block; width:1280px; height:200px; object-fit:contain; }
      .msg { font-family: system-ui, sans-serif; color:#bbb; }
    </style>
  </head>
  <body>
    <div id="wrap">
      <div id="status" class="msg">Loading…</div>
      <img id="card" alt="scorecard" style="display:none" />
    </div>

    <script>
      const params = new URLSearchParams(location.search);
      let user = (params.get('user') || '').trim().toLowerCase();
      if (!user || !/^[a-z0-9._-]{2,32}$/.test(user)) {
        document.getElementById('status').textContent = 'Invalid or missing ?user=';
      } else {
        const OWNER = "Glover27";
        const REPO  = "biker-yoshi";
        const BRANCH = "main";
        const PATH = `scorecards/${encodeURIComponent(user)}.png`;
    
        const statusEl = document.getElementById('status');
        const imgEl = document.getElementById('card');
    
        let lastHead = null;
        let etag = null; // cache ETag for contents call
    
        async function getHeadSha() {
          const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/git/ref/heads/${BRANCH}`);
          if (!r.ok) throw new Error("head ref fetch failed");
          const j = await r.json();
          return j.object.sha;
        }
    
        async function getImageBase64() {
          const headers = etag ? { "If-None-Match": etag } : {};
          const r = await fetch(
            `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`,
            { headers }
          );
          if (r.status === 304) return null; // not modified
          if (!r.ok) throw new Error("contents fetch failed");
          etag = r.headers.get("ETag") || etag;
          const j = await r.json();
          return j.content; // base64
        }
    
        async function refresh() {
          try {
            const head = await getHeadSha();
            if (head !== lastHead) {
              const b64 = await getImageBase64();
              if (b64) {
                imgEl.src = `data:image/png;base64,${b64.replace(/\n/g,'')}`;
                statusEl.style.display = 'none';
                imgEl.style.display = 'block';
              }
              lastHead = head;
            }
          } catch (e) {
            statusEl.textContent = 'Waiting for image…';
            imgEl.style.display = 'none';
          }
        }
    
        refresh();
        // Poll modestly; you can go faster/slower as needed.
        setInterval(refresh, 5000);
      }
    </script>
  </body>
</html>
